<html>
    <head>
        <meta charset="UTF-8">
        <title>CS:GO Autoexec Util</title>
        <style>
            .sidebar{
                background-color: #222;
                height: 100%;
                width: 250px;
                margin-top: 30px;
                left: 0px;
                top: 0px;
                position: fixed;
                z-index: 10;
            }
            .main{
                margin-left: 250px;
                margin-top:30px;
            }
            body{
                margin:0;
                font-family: sans-serif;
                background-color: #555;
                color:white;
            }
            .sidebar-entry{
                height:50px;
                width:100%;
                font-size:20;
                line-height: 50px;
                text-align: center;
                vertical-align: middle;
            }
            .sidebar-entry:hover{
                color:#007fff;
                background-color: #333;
            }
            .title-bar{
                background-color: #444;
                top:0px;
                left:0px;
                position: fixed;
                width: 100%;
                height: 30px;
                z-index: 20;
                -webkit-app-region: drag;
                line-height: 30px;
                text-align: center;
            }
            .title-bar-button-container {
                -webkit-app-region: no-drag;
                height: 100%;
                float:right;
                z-index: 21;
            }
            .title-bar-button {
                float:left;
                width:50px;
                height:100%;
                text-align: center;
                vertical-align: middle;
            }
            .title-bar-button:hover{
                background-color: #777;
            }
            .title-bar-button-exit {
                float:left;
                width:50px;
                height:100%;
                text-align: center;
                vertical-align: middle;
            }
            .title-bar-button-exit:hover{
                background-color: #C00;
            }
        </style>
        <script>
            const electron = require("electron");
            const fs = require("fs");
            const autoexec = require("./autoexec.js");

            function getCurrentUserCfgFile(user_data){
                let random_id = Math.round(Math.random() * Math.pow(2,32)).toString(16);
                let target_file = "autoexec_util_" + random_id + ".cfg";
                electron.shell.openExternal("steam://run/730//+host_writeconfig autoexec_util_" + random_id + " +quit/");
                let user_folders = fs.readdirSync(user_data);
                let end_time = Date.now() + 20000;
                while(Date.now() <= end_time){
                    for(var i = 0; i < user_folders.length; i++){
                        try {
                            let user_configs = fs.readdirSync(user_data + "\\" + user_folders[i] + "\\730\\local\\cfg");
                            for(var j = 0; j < user_configs.length; j++){
                                if(user_configs[j] == target_file){
                                    return user_data + "\\" + user_folders[i] + "\\730\\local\\cfg\\" + target_file
                                }
                            }
                        } catch {
                            continue
                        }
                    }
                }
                throw "Timed Out";
            };
            function open_autoexec_button(){
                alert("Not implemented yet.");
            }

            function open_config_button(){
                if(fs.existsSync("C:\\Program Files (x86)\\Steam\\userdata")){
                    try {
                        openConfig(["C:\\Program Files (x86)\\Steam"]);
                        return;
                    } catch (err){
                        console.log("Failed to find config in: C:\\Program Files (x86)\\Steam\\userdata");
                        console.log(err);
                    }
                }
                electron.dialog.showOpenDialog(
                    autoexec_manager.main_window,
                    {
                        title:"Select your steam install directory",
                        defaultPath:"C:\\Program Files (x86)",
                        properties:["openDirectory"]
                    },
                    openConfig
                );
            };

            function openConfig(file_paths){
                let user_data;
                try {
                    user_data = file_paths[0] + "\\userdata";
                } catch {
                    console.log("Invalid input '" + file_paths + "' to function: openConfig");
                    return
                }
                if(fs.existsSync(file_paths[0] + "\\userdata")){
                    let cfg_file = getCurrentUserCfgFile(user_data);
                    console.log("Found config file: '" + cfg_file + "'");

                    let cfg_data = fs.readFileSync(cfg_file).toString();

                    fs.unlinkSync(cfg_file);

                    autoexec_manager.current_autoexec = new autoexec.AutoExec(cfg_data);

                } else {
                    electron.dialog.showErrorBox("Invalid Path", file_paths[0] + "\\userdata does not exist.");
                    return
                }
            };

            function close_button(){
                electron.remote.app.exit();
            }
            function minimize_button(){
                electron.remote.getCurrentWindow().minimize();
            }
            function min_max_button(){
                if(electron.remote.getCurrentWindow().isMaximized()) {
                    electron.remote.getCurrentWindow().unmaximize();
                } else {
                    electron.remote.getCurrentWindow().maximize();
                }
            }

            var autoexec_manager = {

            };
        </script>
    </head>
    <body>
        <div class="title-bar">
            CS:GO Autoexec Util
            <div class="title-bar-button-container">
                <div class="title-bar-button" onclick="minimize_button()">
                    <span>-</span>
                </div>
                <div class="title-bar-button" onclick="min_max_button()">
                    <span>M</span>
                </div>
                <div class="title-bar-button-exit" onclick="close_button()">
                    <span>X</span>
                </div>
            </div>
        </div>
        <div class="sidebar">

            <div id="file_sidebar_menu">
                <div id="sidebar_open_config" class="sidebar-entry" onclick="open_config_button()">
                    <span>
                        Open Config
                    </span>
                </div>
                <div id="sidebar_open_autoexec" class="sidebar-entry" onclick="open_autoexec_button()">
                    <span>
                        Open Autoexec
                    </span>
                </div>
            </div>

        </div>
        <div class="main">

        </div>
    </body>
</html>